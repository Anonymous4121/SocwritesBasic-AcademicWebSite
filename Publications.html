<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Publications</title>
  <link rel="stylesheet" href="css/PublicationsPage.css" />
  <link rel="stylesheet" href="css/HomePage.css" />
  <style>
    .loading { text-align: center; color: var(--taupe); font-style: italic; }
    .error-msg { color: #d32f2f; background: #ffebee; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container centered-header">
      <img src="./images/logo/logo3.png" alt="SocWrites Logo" class="logo" />
      <h1>SocWrites Journal</h1>
      <hr class="header-separator" />
      <nav>
        <ul>
          <li><a href="./index.html">Home</a></li>
          <li><a href="./Publications.html" class="active">Publications</a></li>
          <li><a href="./submit.html">Submit</a></li>
          <li><a href="./About_Us.html">About Us</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Search Button + Expandable Search Bar -->
    <div class="search-section">
      <button id="search-toggle">Search</button>
      <input type="text" id="search-bar" placeholder="Search articles..." />
    </div>

    <!-- Search Overlay (initially hidden) -->
    <div id="search-overlay" style="display:none;">
      <div class="search-page-inner">
        <button id="close-search-overlay" class="close-btn">&times;</button>
        <h2>Search Articles</h2>
        <input type="text" id="overlay-search-bar" placeholder="Type to search articles...">
        <div id="overlay-articles-grid" class="publications-grid"></div>
        <p id="overlay-no-results" style="display:none; text-align:center; margin-top:2rem; font-size:1.2rem; color:var(--taupe);font-style:italic;">No results found.</p>
      </div>
    </div>

    <!-- Articles Grid -->
    <section class="publications-grid" id="publications-grid">
      <div class="loading">Loading articles from Strapi...</div>
    </section>

    <!-- Pagination Controls -->
    <div class="pagination-nav">
      <button id="back-page-btn" style="visibility: hidden;">&larr; Back</button>
      <button id="next-page-btn" disabled>Next &rarr;</button>
    </div>
    
    <!-- No results message -->
    <p id="no-results-msg" style="display:none; text-align:center; margin-top: 1rem; font-style: italic; color: var(--taupe);">
      No articles found.
    </p>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-column">
        <h3>SocWrites</h3>
        <p>Where Research Meets Readers.</p>
        <p>¬© 2025 SocWrites. All Rights Reserved.</p>
      </div>
      <div class="footer-column">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="Publications.html">Publications</a></li>
          <li><a href="submit.html">Submit</a></li>
          <li><a href="About_Us.html">About Us</a></li>
          <li><a href="mailto:support@socwrites.org">FAQ</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4>Contact Us</h4>
        <p>Email: <a href="mailto:editor@socwrites.org">editor@socwrites.org</a></p>
        <p>Phone: +91 9650XXX101</p>
        <p>New Delhi, India</p>
        <div class="social-icons">
          <a href="https://www.facebook.com"><img src="images/logo/Facebook.svg" alt="Facebook" /></a>
          <a href="https://www.instagram.com/thesocwrites"><img src="images/logo/Instagram.svg" alt="Instagram" /></a>
        </div>
      </div>
    </div>
  </footer>

<script>
  const API_BASE = "https://glowing-star-d89f1652ea.strapiapp.com";
  const grid = document.getElementById('publications-grid');
  const nextBtn = document.getElementById('next-page-btn');
  const backBtn = document.getElementById('back-page-btn');
  const noResultsMsg = document.getElementById('no-results-msg');
  const ARTICLES_PER_PAGE = 12;
  let allArticles = [];        // Current pagination page
  let allStrapiArticles = [];  // ALL articles for search (new!)
  let totalPages = 0;
  let currentStrapiPage = 1;
  let isLoading = false;

  // CLIENT-SIDE CACHING
  const articleCache = new Map();
  const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

  function goToArticle(articleId) {
    window.location.href = `./articlesPage.html?id=${articleId}`;
  }

  function createSkeletonCard() {
    const card = document.createElement('article');
    card.className = 'pub-card skeleton';
    card.style.minHeight = '320px';
    card.innerHTML = `
      <div style="height: 150px; width: 100%; border-radius: 6px; margin-bottom: 0.75rem;"></div>
      <div style="height: 20px; width: 80%; margin: 0 auto 0.4rem; border-radius: 4px;"></div>
      <div style="height: 16px; width: 60%; margin: 0 auto; border-radius: 4px;"></div>
    `;
    return card;
  }

  function showSkeleton() {
    grid.innerHTML = '';
    for (let i = 0; i < ARTICLES_PER_PAGE; i++) {
      grid.appendChild(createSkeletonCard());
    }
  }

  function createArticleCard(article) {
    const attrs = article.attributes || article;
    const id = article.id;
    const title = attrs.Title || attrs.title || 'Untitled';
    const author = attrs.Author || attrs.author || 'Unknown';
    const publishDate = attrs.PublishDate || 'No date';
    const imgUrl = getImageUrl(article);

    const card = document.createElement('article');
    card.className = 'pub-card';
    card.setAttribute('data-id', id);
    card.style.cursor = 'pointer';
    
    card.innerHTML = `
      <img src="${imgUrl}" alt="${title}" onerror="this.src='./images/logo/DefaultImage.svg'" loading="lazy" />
      <h3>${title}</h3>
      <p class="meta">By ${author} | ${publishDate}</p>
    `;

    card.addEventListener('click', () => goToArticle(id));
    return card;
  }

  function getImageUrl(article) {
    try {
      const imgPath = article.ArticleImage?.data?.attributes?.url || 
                      article.attributes?.ArticleImage?.data?.attributes?.url;
      if (imgPath) {
        return imgPath.startsWith('http') ? imgPath : API_BASE + imgPath;
      }
    } catch (e) {}
    return "./images/logo/DefaultImage.svg";
  }

  // OPTIMIZED STRAPI FETCH (Pagination pages)
  async function fetchArticlesFromStrapi(pageNum) {
    const cacheKey = `articles-page-${pageNum}`;
    const cached = articleCache.get(cacheKey);
    
    if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
      return cached.data;
    }

    try {
      const response = await fetch(
        `${API_BASE}/api/articles?populate=ArticleImage&pagination[page]=${pageNum}&pagination[pageSize]=${ARTICLES_PER_PAGE}`
      );
      
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const json = await response.json();
      
      articleCache.set(cacheKey, {
        data: {
          articles: json.data || [],
          totalPages: json.meta?.pagination?.pageCount || 0
        },
        timestamp: Date.now()
      });
      
      return {
        articles: json.data || [],
        totalPages: json.meta?.pagination?.pageCount || 0
      };
    } catch (error) {
      console.error('Strapi error:', error);
      throw error;
    }
  }

  // NEW: Fetch ALL articles for search
  async function fetchAllArticlesForSearch() {
    const cacheKey = 'all-articles-search';
    const cached = articleCache.get(cacheKey);
    
    if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
      return cached.data;
    }

    try {
      const response = await fetch(
        `${API_BASE}/api/articles?populate=ArticleImage&pagination[pageSize]=1000`
      );
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const json = await response.json();
      
      const allArticlesData = json.data || [];
      articleCache.set(cacheKey, {
        data: allArticlesData,
        timestamp: Date.now()
      });
      
      console.log('üîç Cached ALL articles for search:', allArticlesData.length);
      return allArticlesData;
    } catch (error) {
      console.error('Search fetch error:', error);
      return [];
    }
  }

  // Load current pagination page
  async function loadCurrentPage() {
    if (isLoading) return;
    isLoading = true;
    
    showSkeleton();
    
    try {
      const { articles, totalPages: strapiTotal } = await fetchArticlesFromStrapi(currentStrapiPage);
      allArticles = articles;
      totalPages = strapiTotal;
      
      console.log(`üìö Page ${currentStrapiPage}:`, articles.length, 'articles');
      
      if (articles.length === 0) {
        grid.innerHTML = '<div class="loading">No articles found.</div>';
        return;
      }
      
      renderArticles();
      
    } catch (error) {
      console.error('Load error:', error);
      grid.innerHTML = `
        <div class="error-msg">
          ‚ùå Failed to load page ${currentStrapiPage}: ${error.message}
        </div>
      `;
    } finally {
      isLoading = false;
    }
  }

  function renderArticles() {
    grid.innerHTML = '';
    
    if (allArticles.length === 0) {
      noResultsMsg.style.display = 'block';
      nextBtn.style.display = 'none';
      backBtn.style.display = 'none';
      return;
    }

    noResultsMsg.style.display = 'none';
    
    allArticles.forEach(article => {
      grid.appendChild(createArticleCard(article));
    });

    backBtn.style.visibility = currentStrapiPage > 1 ? 'visible' : 'hidden';
    nextBtn.disabled = currentStrapiPage >= totalPages;
    
    if (totalPages <= 1) {
      nextBtn.style.display = 'none';
      backBtn.style.display = 'none';
    } else {
      nextBtn.style.display = 'inline-block';
      backBtn.style.display = 'inline-block';
    }
  }

  // UPDATED SEARCH: Scans ALL Strapi articles
  const searchToggleBtn = document.getElementById("search-toggle");
  const overlay = document.getElementById('search-overlay');
  const overlayCloseBtn = document.getElementById('close-search-overlay');
  const overlaySearchInput = document.getElementById('overlay-search-bar');
  const overlayArticlesGrid = document.getElementById('overlay-articles-grid');
  const overlayNoResults = document.getElementById('overlay-no-results');

  function showSkeletonOverlay() {
    overlayArticlesGrid.innerHTML = '';
    for (let i = 0; i < 8; i++) {
      overlayArticlesGrid.appendChild(createSkeletonCard());
    }
  }

  async function showOverlayArticles(query) {
    overlayArticlesGrid.innerHTML = '';
    
    // Empty search = show current page
    if (!query || query.trim() === '') {
      allArticles.forEach(article => {
        overlayArticlesGrid.appendChild(createArticleCard(article));
      });
      overlayNoResults.style.display = 'none';
      overlayArticlesGrid.style.display = 'grid';
      return;
    }
    
    // Show skeleton while fetching all articles
    showSkeletonOverlay();
    
    // Fetch ALL articles (cached after first search)
    allStrapiArticles = await fetchAllArticlesForSearch();
    
    // Filter ALL articles
    const filtered = allStrapiArticles.filter(article => {
      const attrs = article.attributes || article;
      const title = (attrs.Title || attrs.title || '').toLowerCase();
      const author = (attrs.Author || attrs.author || '').toLowerCase();
      return title.includes(query.toLowerCase()) || author.includes(query.toLowerCase());
    });

    // Clear skeleton and show results
    overlayArticlesGrid.innerHTML = '';
    
    if (filtered.length === 0) {
      overlayArticlesGrid.style.display = 'none';
      overlayNoResults.style.display = 'block';
    } else {
      overlayArticlesGrid.style.display = 'grid';
      overlayNoResults.style.display = 'none';
      filtered.forEach(article => {
        overlayArticlesGrid.appendChild(createArticleCard(article));
      });
      console.log(`üîç Found ${filtered.length} articles for "${query}"`);
    }
  }

  // Event listeners
  nextBtn.addEventListener("click", async () => {
    if (currentStrapiPage < totalPages && !isLoading) {
      currentStrapiPage++;
      await loadCurrentPage();
      window.scrollTo({ top: grid.offsetTop - 100, behavior: 'smooth' });
    }
  });

  backBtn.addEventListener("click", async () => {
    if (currentStrapiPage > 1 && !isLoading) {
      currentStrapiPage--;
      await loadCurrentPage();
      window.scrollTo({ top: grid.offsetTop - 100, behavior: 'smooth' });
    }
  });

  searchToggleBtn.addEventListener('click', () => {
    overlay.style.display = 'block';
    overlaySearchInput.focus();
    showOverlayArticles(''); // Show current page initially
  });

  overlayCloseBtn.addEventListener('click', () => {
    overlay.style.display = 'none';
  });

  overlaySearchInput.addEventListener('input', (e) => {
    showOverlayArticles(e.target.value);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === "Escape" && overlay.style.display === "block") {
      overlay.style.display = 'none';
    }
  });

  // Initial load
  window.addEventListener('load', () => {
    currentStrapiPage = 1;
    loadCurrentPage();
  });
</script>
</body>
</html>
