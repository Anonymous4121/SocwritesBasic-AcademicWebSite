<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Publications</title>
  <link rel="stylesheet" href="css/PublicationsPage.css" />
  <link rel="stylesheet" href="css/HomePage.css" />
  <style>
    .loading { text-align: center; color: var(--taupe); font-style: italic; }
    .error-msg { color: #d32f2f; background: #ffebee; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container centered-header">
      <img src="./images/logo/logo3.png" alt="SocWrites Logo" class="logo" />
      <h1>SocWrites Journal</h1>
      <hr class="header-separator" />
      <nav>
        <ul>
          <li><a href="./index.html">Home</a></li>
          <li><a href="./Publications.html" class="active">Publications</a></li>
          <li><a href="./submit.html">Submit</a></li>
          <li><a href="./About_Us.html">About Us</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Search Button + Expandable Search Bar -->
    <div class="search-section">
      <button id="search-toggle">Search</button>
      <input type="text" id="search-bar" placeholder="Search articles..." />
    </div>

    <!-- Search Overlay (initially hidden) -->
    <div id="search-overlay" style="display:none;">
      <div class="search-page-inner">
        <button id="close-search-overlay" class="close-btn">&times;</button>
        <h2>Search Articles</h2>
        <input type="text" id="overlay-search-bar" placeholder="Type to search articles...">
        <div id="overlay-articles-grid" class="publications-grid"></div>
        <p id="overlay-no-results" style="display:none; text-align:center; margin-top:2rem; font-size:1.2rem; color:var(--taupe);font-style:italic;">No results found.</p>
      </div>
    </div>

    <!-- Articles Grid -->
    <section class="publications-grid" id="publications-grid">
      <div class="loading">Loading articles...</div>
    </section>

    <!-- Pagination Controls -->
    <div class="pagination-nav">
      <button id="back-page-btn" style="visibility: hidden;">&larr; Back</button>
      <button id="next-page-btn" disabled>Next &rarr;</button>
    </div>
    
    <!-- No results message -->
    <p id="no-results-msg" style="display:none; text-align:center; margin-top: 1rem; font-style: italic; color: var(--taupe);">
      No articles found.
    </p>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-column">
        <h3>SocWrites</h3>
        <p>Where Research Meets Readers.</p>
        <p>¬© 2025 SocWrites. All Rights Reserved.</p>
      </div>
      <div class="footer-column">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="Publications.html">Publications</a></li>
          <li><a href="submit.html">Submit</a></li>
          <li><a href="About_Us.html">About Us</a></li>
          <li><a href="mailto:support@socwrites.org">FAQ</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4>Contact Us</h4>
        <p>Email: <a href="mailto:editor@socwrites.org">editor@socwrites.org</a></p>
        <p>Phone: +91 9650XXX101</p>
        <p>New Delhi, India</p>
        <div class="social-icons">
          <a href="https://www.facebook.com"><img src="images/logo/Facebook.svg" alt="Facebook" /></a>
          <a href="https://www.instagram.com/thesocwrites"><img src="images/logo/Instagram.svg" alt="Instagram" /></a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    const API_BASE = "https://glowing-star-d89f1652ea.strapiapp.com";
    const grid = document.getElementById('publications-grid');
    const nextBtn = document.getElementById('next-page-btn');
    const backBtn = document.getElementById('back-page-btn');
    const noResultsMsg = document.getElementById('no-results-msg');
    const ARTICLES_PER_PAGE = 12;
    let allArticles = [];
    let page = 0;
    let paginatedFiltered = [];

    // Navigation helper - uses article.id (matches articlesPage.html)
    function goToArticle(articleId) {
      window.location.href = `./articlesPage.html?id=${articleId}`;
    }

    // Create article card from Strapi data
    function createArticleCard(article, index) {
      const attrs = article.attributes || article;
      const id = article.id;
      const title = attrs.Title || attrs.title || 'Untitled';
      const author = attrs.Author || attrs.author || 'Unknown';
      const publishDate = attrs.PublishDate || 'No date';
      const imgUrl = getImageUrl(article);

      const card = document.createElement('article');
      card.className = 'pub-card';
      card.setAttribute('data-id', id);
      card.style.cursor = 'pointer';
      
      card.innerHTML = `
        <img src="${imgUrl}" alt="${title}" onerror="this.src='./images/logo/DefaultImage.svg'" />
        <h3>${title}</h3>
        <p class="meta">By ${author} | ${publishDate}</p>
      `;

      // Make clickable
      card.addEventListener('click', () => goToArticle(id));
      return card;
    }

    // Get Strapi image URL
    function getImageUrl(article) {
      try {
        if (article.ArticleImage?.data?.attributes?.url) {
          return API_BASE + article.ArticleImage.data.attributes.url;
        }
        if (article.attributes?.ArticleImage?.data?.attributes?.url) {
          return API_BASE + article.attributes.ArticleImage.data.attributes.url;
        }
      } catch (e) {}
      return "./images/logo/DefaultImage.svg";
    }

    // Load all articles from Strapi
    async function loadArticles() {
      try {
        grid.innerHTML = '<div class="loading">üîÑ Fetching articles...</div>';
        
        const response = await fetch(`${API_BASE}/api/articles?populate=*`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const json = await response.json();
        allArticles = json.data || [];
        
        console.log('üìö Loaded', allArticles.length, 'articles');
        
        if (allArticles.length === 0) {
          grid.innerHTML = '<div class="loading">No articles found in backend.</div>';
          return;
        }

        // Render initial page
        paginatedFiltered = allArticles;
        renderPage();
        
      } catch (error) {
        console.error('Backend error:', error);
        grid.innerHTML = `
          <div class="error-msg">
            ‚ùå Failed to load articles: ${error.message}<br>
            <small>Check Backend permissions: Public ‚Üí Articles ‚Üí find</small>
          </div>
        `;
      }
    }

    // Pagination
    function renderPage() {
      grid.innerHTML = '';
      
      const start = page * ARTICLES_PER_PAGE;
      const end = start + ARTICLES_PER_PAGE;
      const pageArticles = paginatedFiltered.slice(start, end);

      if (pageArticles.length === 0) {
        noResultsMsg.style.display = 'block';
        nextBtn.style.display = 'none';
        backBtn.style.display = 'none';
        return;
      }

      noResultsMsg.style.display = 'none';
      
      pageArticles.forEach(article => {
        const card = createArticleCard(article);
        grid.appendChild(card);
      });

      const totalPages = Math.ceil(paginatedFiltered.length / ARTICLES_PER_PAGE);
      backBtn.style.visibility = page > 0 ? 'visible' : 'hidden';
      nextBtn.disabled = page >= totalPages - 1;
      
      if (totalPages <= 1) {
        nextBtn.style.display = 'none';
        backBtn.style.display = 'none';
      } else {
        nextBtn.style.display = 'inline-block';
        backBtn.style.display = 'inline-block';
      }
    }

    // Search functionality
    const searchToggleBtn = document.getElementById("search-toggle");
    const overlay = document.getElementById('search-overlay');
    const overlayCloseBtn = document.getElementById('close-search-overlay');
    const overlaySearchInput = document.getElementById('overlay-search-bar');
    const overlayArticlesGrid = document.getElementById('overlay-articles-grid');
    const overlayNoResults = document.getElementById('overlay-no-results');

    function showOverlayArticles(query) {
      overlayArticlesGrid.innerHTML = '';
      
      const filtered = allArticles.filter(article => {
        const attrs = article.attributes || article;
        const title = (attrs.Title || attrs.title || '').toLowerCase();
        const author = (attrs.Author || attrs.author || '').toLowerCase();
        return title.includes(query.toLowerCase()) || author.includes(query.toLowerCase());
      });

      if (filtered.length === 0) {
        overlayArticlesGrid.style.display = "none";
        overlayNoResults.style.display = "block";
      } else {
        overlayArticlesGrid.style.display = "grid";
        overlayNoResults.style.display = "none";
        filtered.forEach(article => {
          const card = createArticleCard(article);
          overlayArticlesGrid.appendChild(card);
        });
      }
    }

    // Event listeners
    nextBtn.addEventListener("click", () => {
      const totalPages = Math.ceil(paginatedFiltered.length / ARTICLES_PER_PAGE);
      if (page < totalPages - 1) {
        page++;
        renderPage();
        window.scrollTo({ top: grid.offsetTop, behavior: 'smooth' });
      }
    });

    backBtn.addEventListener("click", () => {
      if (page > 0) {
        page--;
        renderPage();
        window.scrollTo({ top: grid.offsetTop, behavior: 'smooth' });
      }
    });

    searchToggleBtn.addEventListener('click', () => {
      overlay.style.display = 'block';
      overlaySearchInput.focus();
      showOverlayArticles('');
    });

    overlayCloseBtn.addEventListener('click', () => {
      overlay.style.display = 'none';
    });

    overlaySearchInput.addEventListener('input', (e) => {
      showOverlayArticles(e.target.value);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === "Escape" && overlay.style.display === "block") {
        overlay.style.display = 'none';
      }
    });

    // Load articles on page load
    window.addEventListener('load', loadArticles);
  </script>
</body>
</html>
