<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Publications</title>
  <link rel="stylesheet" href="css/PublicationsPage.css" />
  <link rel="stylesheet" href="css/HomePage.css" />
</head>
<body>
  <!-- Header (your exact original) -->
  <header>
    <div class="container centered-header">
      <img src="./images/logo/logo3.png" alt="SocWrites Logo" class="logo" />
      <h1>SocWrites Journal</h1>
      <hr class="header-separator" />
      <nav>
        <ul>
          <li><a href="./index.html">Home</a></li>
          <li><a href="./Publications.html" class="active">Publications</a></li>
          <li><a href="./submit.html">Submit</a></li>
          <li><a href="./About_Us.html">About Us</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Search Section -->
    <div class="search-section">
      <button id="search-toggle">üîç Search</button>
      <input type="text" id="search-bar" placeholder="Search articles..." />
    </div>

    <!-- Search Overlay - HIDDEN BY CSS -->
    <div id="search-overlay">
      <div class="search-page-inner">
        <button id="close-search-overlay" class="close-btn">&times;</button>
        <h2>Search Articles</h2>
        <input type="text" id="overlay-search-bar" placeholder="Type to search articles...">
        <div id="overlay-articles-grid" class="publications-grid"></div>
        <p id="overlay-no-results">No results found.</p>
      </div>
    </div>

    <!-- Publications Grid - 12 SKELETONS -->
    <section class="publications-grid" id="publications-grid">
      <!-- 12 Skeleton Cards -->
      ${Array.from({length: 12}, (_, i) => `
        <article class="pub-card" style="
          background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
          background-size: 200% 100%;
          animation: loading 1.5s infinite;
          animation-delay: ${i * 0.1}s;
        ">
          <div style="height:150px;background:#f0f0f0;border-radius:6px;"></div>
          <div style="height:20px;background:#f0f0f0;border-radius:4px;margin:8px 0;width:80%;"></div>
          <div style="height:16px;background:#f0f0f0;border-radius:4px;width:60%;"></div>
        </article>
      `).join('')}
    </section>

    <!-- Pagination -->
    <div class="pagination-nav">
      <button id="back-page-btn" style="visibility: hidden;">&larr; Back</button>
      <button id="next-page-btn" disabled>Next &rarr;</button>
    </div>
    
    <p id="no-results-msg" style="display:none;">No articles found.</p>
  </main>

  <!-- Footer (your exact original) -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-column">
        <h3>SocWrites</h3>
        <p>Where Research Meets Readers.</p>
        <p>¬© 2025 SocWrites. All Rights Reserved.</p>
      </div>
      <div class="footer-column">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="Publications.html">Publications</a></li>
          <li><a href="submit.html">Submit</a></li>
          <li><a href="About_Us.html">About Us</a></li>
          <li><a href="mailto:support@socwrites.org">FAQ</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4>Contact Us</h4>
        <p>Email: <a href="mailto:editor@socwrites.org">editor@socwrites.org</a></p>
        <p>Phone: +91 9650XXX101</p>
        <p>New Delhi, India</p>
        <div class="social-icons">
          <a href="https://www.facebook.com"><img src="images/logo/Facebook.svg" alt="Facebook" /></a>
          <a href="https://www.instagram.com/thesocwrites"><img src="images/logo/Instagram.svg" alt="Instagram" /></a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    const API_BASE = "https://glowing-star-d89f1652ea.strapiapp.com";
    const CACHE_KEY = 'strapi_articles_v1';
    const CACHE_DURATION = 5 * 60 * 1000; // 5 min
    
    let allArticles = [], page = 0, paginatedFiltered = [];
    const ARTICLES_PER_PAGE = 12;

    function createArticleCard(article) {
      const attrs = article.attributes || article;
      const id = article.id;
      const title = (attrs.Title || 'Untitled').substring(0, 60);
      const author = attrs.Author || 'Unknown';
      const date = attrs.PublishDate?.split('T')[0] || 'No date';
      const imgUrl = attrs.ArticleImage?.data?.attributes?.url 
        ? `${API_BASE}${attrs.ArticleImage.data.attributes.url}` 
        : './images/logo/DefaultImage.svg';

      const card = document.createElement('article');
      card.className = 'pub-card';
      card.dataset.id = id;
      card.innerHTML = `
        <img src="${imgUrl}" alt="${title}" loading="lazy" 
             onerror="this.src='./images/logo/DefaultImage.svg'" />
        <h3 title="${title}">${title}</h3>
        <p class="meta">By ${author} | ${date}</p>
      `;
      card.onclick = () => window.location.href = `./articlesPage.html?id=${id}`;
      return card;
    }

    async function loadArticles() {
      const grid = document.getElementById('publications-grid');
      
      // ‚ö° 1. TRY CACHE FIRST
      const cached = localStorage.getItem(CACHE_KEY);
      const cacheTime = localStorage.getItem(`${CACHE_KEY}_time`);
      if (cached && cacheTime && Date.now() - parseInt(cacheTime) < CACHE_DURATION) {
        allArticles = JSON.parse(cached);
        renderPage();
        console.log('‚ö° CACHE HIT - Instant load!');
        return;
      }

      // ‚ö° 2. OPTIMIZED API CALL
      try {
        const response = await fetch(
          `${API_BASE}/api/articles?populate=ArticleImage&fields[0]=Title&fields[1]=Author&fields[2]=PublishDate`
        );
        const json = await response.json();
        allArticles = json.data || [];
        
        // Save cache
        localStorage.setItem(CACHE_KEY, JSON.stringify(allArticles));
        localStorage.setItem(`${CACHE_KEY}_time`, Date.now().toString());
        
        renderPage();
      } catch (error) {
        grid.innerHTML = '<article class="pub-card" style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--taupe);"><p>Failed to load articles</p></article>';
      }
    }

    function renderPage() {
      const grid = document.getElementById('publications-grid');
      grid.innerHTML = '';
      
      const start = page * ARTICLES_PER_PAGE;
      const end = start + ARTICLES_PER_PAGE;
      paginatedFiltered = allArticles;
      
      allArticles.slice(start, end).forEach(article => {
        grid.appendChild(createArticleCard(article));
      });

      // Pagination buttons
      const totalPages = Math.ceil(allArticles.length / ARTICLES_PER_PAGE);
      document.getElementById('back-page-btn').style.visibility = page > 0 ? 'visible' : 'hidden';
      document.getElementById('next-page-btn').disabled = page >= totalPages - 1 || totalPages <= 1;
    }

    // üñ±Ô∏è Event Listeners
    document.getElementById('next-page-btn').onclick = () => {
      const totalPages = Math.ceil(allArticles.length / ARTICLES_PER_PAGE);
      if (page < totalPages - 1) {
        page++;
        renderPage();
        window.scrollTo({top: 0, behavior: 'smooth'});
      }
    };

    document.getElementById('back-page-btn').onclick = () => {
      if (page > 0) {
        page--;
        renderPage();
        window.scrollTo({top: 0, behavior: 'smooth'});
      }
    };

    // üîç Search Overlay
    document.getElementById('search-toggle').onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('search-overlay').style.display = 'block';
      document.getElementById('overlay-search-bar').focus();
    };

    document.getElementById('close-search-overlay').onclick = () => {
      document.getElementById('search-overlay').style.display = 'none';
    };

    document.getElementById('overlay-search-bar').oninput = (e) => {
      const query = e.target.value.toLowerCase();
      const overlayGrid = document.getElementById('overlay-articles-grid');
      overlayGrid.innerHTML = '';
      
      const filtered = allArticles.filter(article => {
        const attrs = article.attributes || article;
        return (attrs.Title?.toLowerCase().includes(query) || 
                attrs.Author?.toLowerCase().includes(query));
      });
      
      filtered.slice(0, 20).forEach(article => {
        overlayGrid.appendChild(createArticleCard(article));
      });
      
      document.getElementById('overlay-no-results').style.display = filtered.length ? 'none' : 'block';
    };

    // ESC closes overlay
    document.onkeydown = (e) => {
      if (e.key === 'Escape') {
        document.getElementById('search-overlay').style.display = 'none';
      }
    };

    // Load on page ready
    window.addEventListener('load', loadArticles);
  </script>
</body>
</html>
